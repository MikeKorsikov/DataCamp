<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laserovo - Appointments</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <style>
        /* Calendar Modal Styles */
        #calendar-view-modal .modal {
            max-width: 1000px;
            width: 95%;
        }
        #calendar {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .fc-toolbar-title {
            font-size: 1.5em;
        }
        .fc-button {
            background: #4a90e2;
            border: 1px solid #4a90e2;
        }
        .fc-button:hover {
            background: #357abd;
        }
        .fc-button-active {
            background: #2c3e50;
        }
    </style>
</head>
<body style="background: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), url('assets/appointments.png'); background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat;">
    <main style="max-width:1000px;margin:40px auto;padding:20px;">
        <h1>Managing visits</h1>
        <p>Time to grill that beaver!</p>
        <div class="actions">
            <button id="make-appointment">Make appointment</button>
            <button id="find-appointment">Find appointment</button>
            <button id="show-all">Show all</button>
            <button id="upcoming-appointments">Forecasted appointments</button>
            <button id="calendar-view">Calendar View</button>
        </div>
        <button class="back-button" onclick="location.href='index.html'">Back to Home</button>
    </main>
    
    <!-- Make Appointment Modal -->
    <div class="modal-overlay" id="appointment-modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="appointment-modal-title">
            <div class="modal-header">
                <h2 id="appointment-modal-title">Make Appointment</h2>
            </div>
            <form id="appointment-form" class="modal-body">
                <!-- Client Search Section -->
                <div class="form-section">
                    <h3>Client Search</h3>
                    <div class="form-grid">
                        <label>
                            <span>Search by:</span>
                            <select id="client-search-field">
                                <option value="name">Name</option>
                                <option value="surname">Surname</option>
                                <option value="phone">Phone</option>
                            </select>
                        </label>
                        <label>
                            <span>Search term:</span>
                            <input type="text" id="client-search-term" placeholder="Enter search term...">
                        </label>
                        <div class="button-container">
                            <button type="button" id="search-client-btn">Search Client</button>
                        </div>
                    </div>
                    <div id="client-search-results" class="search-results" hidden>
                        <h4>Search Results</h4>
                        <div id="client-results-list"></div>
                    </div>
                </div>

                <!-- Client Information Section -->
                <div class="form-section">
                    <h3>Client Information</h3>
                    <div class="form-grid">
                        <label>
                            <span>Name</span>
                            <input type="text" id="appointment-name" name="name" readonly>
                        </label>
                        <label>
                            <span>Surname</span>
                            <input type="text" id="appointment-surname" name="surname" readonly>
                        </label>
                    </div>
                </div>

                <!-- Appointment Details Section -->
                <div class="form-section">
                    <h3>Appointment Details</h3>
                    <div class="form-grid">
                        <label>
                            <span>Date</span>
                            <input type="date" id="appointment-date" name="appointment_date" required>
                        </label>
                        <label>
                            <span>Time <small>(24-hour format)</small></span>
                            <input type="time" id="appointment-time" name="appointment_time" required step="900">
                        </label>
                        <label>
                            <span>Area [Zone]</span>
                            <select id="appointment-area" name="area" required>
                                
                                <!-- Areas will be populated by JavaScript -->
                            </select>
                        </label>
                        <label>
                            <span>Power</span>
                            <input type="text" id="appointment-power" name="power" placeholder="Enter power setting">
                        </label>
                        <label>
                            <span>Confirmed</span>
                            <select id="appointment-confirmed" name="confirmed">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </label>
                        <label>
                            <span>Amount (PLN)</span>
                            <input type="number" id="appointment-amount" name="amount_pln" placeholder="0.00" step="0.01" min="0">
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="submit" id="appointment-save">Save</button>
                    <button type="button" id="appointment-cancel" class="secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Find Appointment Modal -->
    <div class="modal-overlay" id="find-appointment-modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="find-appointment-modal-title">
            <div class="modal-header">
                <h2 id="find-appointment-modal-title">Find Appointment</h2>
            </div>
            <form id="find-appointment-form" class="modal-body">
                <div class="form-grid">
                    <label>
                        <span>Search by:</span>
                        <select id="appointment-search-field">
                            <option value="name">Name</option>
                            <option value="surname">Surname</option>
                            <option value="phone">Phone</option>
                            <option value="date">Appointment Date</option>
                        </select>
                    </label>
                    <label>
                        <span>Search term:</span>
                        <input type="text" id="appointment-search-term" placeholder="Enter search term..." required>
                    </label>
                </div>
                <div id="appointment-search-results" class="search-results" hidden>
                    <h4>Search Results</h4>
                    <div id="appointment-results-list"></div>
                </div>
                <div class="modal-actions">
                    <button type="submit" id="find-appointment-search">Search</button>
                    <button type="button" id="find-appointment-cancel" class="secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Appointment Modal -->
    <div class="modal-overlay" id="edit-appointment-modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-appointment-modal-title">
            <div class="modal-header">
                <h2 id="edit-appointment-modal-title">Edit Appointment</h2>
            </div>
            <form id="edit-appointment-form" class="modal-body">
                <!-- Non-editable client information -->
                <div class="client-info-section">
                    <h3>Client Information</h3>
                    <div class="form-grid">
                        <label>
                            <span>Client Name</span>
                            <input type="text" id="edit-appointment-name" name="name" readonly>
                        </label>
                        <label>
                            <span>Client Surname</span>
                            <input type="text" id="edit-appointment-surname" name="surname" readonly>
                        </label>
                    </div>
                </div>
                
                <!-- Editable appointment details -->
                <div class="appointment-details-section">
                    <h3>Appointment Details</h3>
                    <div class="form-grid">
                        <label>
                            <span>Appointment Date & Time <small style="color: #6b7280; font-weight: normal;">(24-hour format)</small></span>
                            <div class="datetime-container">
                                <input type="date" id="edit-appointment-date" name="appointment_date" required>
                                <input type="time" id="edit-appointment-time" name="appointment_time" required step="900">
                            </div>
                        </label>
                        <label>
                            <span>Area [Zone]</span>
                            <select id="edit-appointment-area" name="area" required>
                                
                                <!-- Areas will be populated by JavaScript -->
                            </select>
                        </label>
                        <label>
                            <span>Power</span>
                            <input type="text" id="edit-appointment-power" name="power" placeholder="Enter power setting">
                        </label>
                        <label>
                            <span>Confirmed</span>
                            <select id="edit-appointment-confirmed" name="confirmed">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </label>
                        <label>
                            <span>Amount (PLN)</span>
                            <input type="number" id="edit-appointment-amount" name="amount_pln" placeholder="0.00" step="0.01" min="0">
                        </label>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="submit" id="edit-appointment-save">Save Changes</button>
                    <button type="button" id="edit-appointment-cancel" class="secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Show All Appointments Modal -->
    <div class="modal-overlay" id="show-all-appointments-modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="show-all-appointments-title">
            <div class="modal-header">
                <h2 id="show-all-appointments-title">All Appointments</h2>
            </div>
            <div class="modal-body" id="show-all-appointments-list">
                <!-- Appointments will be dynamically loaded here -->
            </div>
            <div class="modal-actions" style="justify-content: flex-end;">
                <button type="button" id="show-all-next7">Next 7 days</button>
                <button type="button" id="show-all-next30">Next 30 days</button>
                <button type="button" id="show-all-clear" class="secondary">Clear filter</button>
                <button type="button" id="show-all-appointments-cancel" class="secondary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Upcoming Appointments Modal -->
    <div class="modal-overlay" id="upcoming-appointments-modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="upcoming-appointments-title">
            <div class="modal-header">
                <h2 id="upcoming-appointments-title">Forecasted Appointments</h2>
            </div>
            <div class="modal-body">
                <div class="table-wrapper">
                    <table class="data-table" id="upcoming-appointments-table" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Surname</th>
                                <th>Area</th>
                                <th>Last Visit</th>
                                <th>Procedure #</th>
                                <th>Proposed next date</th>
                                <th>Phone</th>
                                <th>E-mail</th>
                                <th>Messenger</th>
                                <th>Instagram</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be dynamically loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-actions" style="justify-content: flex-end;">
                <button type="button" id="upcoming-appointments-next7">Next 7 days</button>
                <button type="button" id="upcoming-appointments-next30">Next 30 days</button>
                <button type="button" id="upcoming-appointments-clear" class="secondary">Clear filter</button>
                <button type="button" id="upcoming-appointments-cancel" class="secondary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the calendar when the modal is shown
            document.getElementById('calendar-view').addEventListener('click', function() {
                document.getElementById('calendar-view-modal').removeAttribute('hidden');
                initCalendar();
            });

            // Close modal when clicking the close button
            document.querySelector('#calendar-view-modal .close-btn').addEventListener('click', function() {
                document.getElementById('calendar-view-modal').setAttribute('hidden', 'true');
            });

            // Close modal when clicking outside the modal content
            document.getElementById('calendar-view-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.setAttribute('hidden', 'true');
                }
            });
        });

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            // Check if calendar is already initialized
            if (calendarEl._fullCalendar) {
                calendarEl._fullCalendar.destroy();
            }

            // Initialize FullCalendar
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                timeZone: 'local',
                firstDay: 1, // Start week on Monday
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'Today',
                    month: 'Month',
                    week: 'Week',
                    day: 'Day'
                },
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false,
                    meridiem: false
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    // Fetch appointments from the server
                    console.log('Fetching appointments...');
                    fetch('/appointments')
                        .then(response => {
                            console.log('Response status:', response.status);
                            return response.json().then(data => {
                                console.log('Response data:', data);
                                return data;
                            });
                        })
                        .then(data => {
                            console.log('Processed data:', data);
                            if (data.status === 'ok' && data.results) {
                                // Transform appointments into FullCalendar event format
                                const events = data.results.map(appointment => ({
                                    id: appointment.visit_id,
                                    title: `${appointment.client_name} - ${appointment.area}`,
                                    start: appointment.appointment_datetime,
                                    backgroundColor: appointment.confirmed === 'yes' ? '#28a745' : '#ffc107',
                                    borderColor: appointment.confirmed === 'yes' ? '#218838' : '#e0a800',
                                    textColor: '#fff',
                                    extendedProps: {
                                        clientName: appointment.client_name,
                                        area: appointment.area,
                                        power: appointment.power,
                                        confirmed: appointment.confirmed === 'yes',
                                        amount: appointment.amount_pln
                                    }
                                }));
                                successCallback(events);
                            } else {
                                console.error('Unexpected response format:', data);
                                successCallback([]);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching appointments:', error);
                            failureCallback(error);
                        });
                },
                eventClick: function(info) {
                    // Show appointment details when an event is clicked
                    const event = info.event;
                    const eventTime = new Date(event.start);
                    const formattedTime = eventTime.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    
                    // Create a more detailed modal instead of an alert
                    const modal = document.createElement('div');
                    modal.style.position = 'fixed';
                    modal.style.top = '50%';
                    modal.style.left = '50%';
                    modal.style.transform = 'translate(-50%, -50%)';
                    modal.style.backgroundColor = 'white';
                    modal.style.padding = '20px';
                    modal.style.borderRadius = '8px';
                    modal.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                    modal.style.zIndex = '1000';
                    modal.style.maxWidth = '400px';
                    modal.style.width = '90%';
                    
                    modal.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <h3 style="margin-top: 0; color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                ${event.extendedProps.clientName}
                            </h3>
                            <p><strong>Area:</strong> ${event.extendedProps.area}</p>
                            <p><strong>When:</strong> ${formattedTime}</p>
                            <p><strong>Power:</strong> ${event.extendedProps.power || 'N/A'}</p>
                            <p><strong>Status:</strong> 
                                <span style="color: ${event.extendedProps.confirmed ? 'green' : '#e67e22'};">
                                    ${event.extendedProps.confirmed ? '✓ Confirmed' : '⚠ Not Confirmed'}
                                </span>
                            </p>
                            ${event.extendedProps.amount ? `<p><strong>Amount:</strong> ${event.extendedProps.amount} PLN</p>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <button id="closeModalBtn" style="
                                background: #4a90e2;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                            ">Close</button>
                        </div>
                    `;
                    
                    // Add overlay
                    const overlay = document.createElement('div');
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.right = '0';
                    overlay.style.bottom = '0';
                    overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    overlay.style.zIndex = '999';
                    
                    // Close modal when clicking the overlay or close button
                    const closeModal = () => {
                        document.body.removeChild(overlay);
                        document.body.removeChild(modal);
                    };
                    
                    overlay.onclick = closeModal;
                    
                    // Append elements to body
                    document.body.appendChild(overlay);
                    document.body.appendChild(modal);
                    
                    // Add event listener to close button
                    document.getElementById('closeModalBtn').onclick = closeModal;
                    
                    info.jsEvent.preventDefault();
                },
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                },
                height: 'auto',
                navLinks: true,
                nowIndicator: true,
                dayMaxEvents: true,
                firstDay: 1 // Start week on Monday
            });

            // Store calendar instance for later reference
            calendarEl._fullCalendar = calendar;
            
            // Render the calendar
            calendar.render();
        }
    </script>
</body>

    <!-- Calendar View Modal -->
    <div class="modal-overlay" id="calendar-view-modal" hidden>
        <div class="modal" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>Appointment Calendar</h2>
            </div>
            <div class="modal-body">
                <div id="calendar"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary" onclick="document.getElementById('calendar-view-modal').setAttribute('hidden', 'true')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Function to populate area dropdowns from CONFIG.AREAS
        function populateAreaDropdowns() {
            const areaSelects = [
                document.getElementById('appointment-area'),
                document.getElementById('edit-appointment-area')
            ];

            // Filter out placeholder areas and sort alphabetically
            const validAreas = CONFIG.AREAS
                .filter(area => !['placeholder2', 'placeholder3'].includes(area.area))
                .sort((a, b) => a.area.localeCompare(b.area));

            areaSelects.forEach(select => {
                if (!select) return;
                
                // Keep the first option (Select Area)
                const firstOption = select.querySelector('option');
                select.innerHTML = '';
                if (firstOption) select.appendChild(firstOption);
                
                // Add areas from CONFIG.AREAS
                validAreas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.area;
                    option.textContent = area.area
                        .split('-')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                    select.appendChild(option);
                });
            });
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', populateAreaDropdowns);
    </script>
</body>
</html>
